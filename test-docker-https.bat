@echo off
chcp 65001 >nul

powershell -ExecutionPolicy Bypass -Command "& { [Console]::OutputEncoding = [System.Text.Encoding]::UTF8; $OutputEncoding = [System.Text.Encoding]::UTF8; Write-Host '=======================================' -ForegroundColor Cyan; Write-Host '資訊安全專案 - Docker 測試腳本 (支援 HTTPS)' -ForegroundColor Cyan; Write-Host '=======================================' -ForegroundColor Cyan; Write-Host ''; if ($args[0] -eq '-Clean') { Write-Host '[清理模式] 停止並刪除容器...' -ForegroundColor Yellow; docker-compose -p infosec down -v 2>$null; if ($LASTEXITCODE -eq 0) { Write-Host '容器清理完成！' -ForegroundColor Green } else { Write-Host '清理過程中出現錯誤' -ForegroundColor Red }; exit }; Write-Host '[1/4] 檢查 Docker...' -ForegroundColor Yellow; $dockerVersion = docker --version 2>$null; if ($LASTEXITCODE -eq 0) { Write-Host \"Docker 版本: $dockerVersion\" -ForegroundColor Green } else { Write-Host '錯誤: Docker 未安裝或未運行' -ForegroundColor Red; Write-Host '請安裝並啟動 Docker Desktop' -ForegroundColor Red; Write-Host '下載地址: https://www.docker.com/products/docker-desktop' -ForegroundColor Yellow; Read-Host '按 Enter 鍵退出'; exit 1 }; Write-Host ''; Write-Host '[2/4] 檢查 Docker Compose...' -ForegroundColor Yellow; $composeVersion = docker-compose --version 2>$null; if ($LASTEXITCODE -eq 0) { Write-Host \"Docker Compose 版本: $composeVersion\" -ForegroundColor Green } else { Write-Host '錯誤: Docker Compose 未安裝' -ForegroundColor Red; Read-Host '按 Enter 鍵退出'; exit 1 }; Write-Host ''; Write-Host '[3/4] 檢查端口衝突...' -ForegroundColor Yellow; $port3001 = netstat -ano | findstr ':3001'; $port3000 = netstat -ano | findstr ':3000'; $port3443 = netstat -ano | findstr ':3443'; if ($port3001) { Write-Host '警告: 端口 3001 已被占用' -ForegroundColor Red; Write-Host '占用進程:' -ForegroundColor Yellow; $port3001; Write-Host '建議: 關閉占用端口的應用程式，或使用 -Force 參數強制清理' -ForegroundColor Yellow; if ($args[0] -ne '-Force') { Read-Host '按 Enter 鍵退出'; exit 1 } } else { Write-Host '端口 3001 可用' -ForegroundColor Green }; if ($port3000) { Write-Host '警告: 端口 3000 已被占用' -ForegroundColor Red; Write-Host '占用進程:' -ForegroundColor Yellow; $port3000 } else { Write-Host '端口 3000 可用' -ForegroundColor Green }; if ($port3443) { Write-Host '警告: 端口 3443 已被占用' -ForegroundColor Red; Write-Host '占用進程:' -ForegroundColor Yellow; $port3443 } else { Write-Host '端口 3443 可用' -ForegroundColor Green }; Write-Host ''; Write-Host '[4/4] 建置並啟動容器...' -ForegroundColor Yellow; Write-Host '正在建置和啟動服務...' -ForegroundColor Cyan; Write-Host '這可能需要幾分鐘，請稍候...' -ForegroundColor Cyan; Write-Host ''; docker-compose -p infosec down -v 2>$null | Out-Null; docker-compose -p infosec up --build -d; if ($LASTEXITCODE -eq 0) { Write-Host '' -ForegroundColor Green; Write-Host '服務啟動成功！' -ForegroundColor Green; Write-Host '前端: http://localhost:3000' -ForegroundColor Cyan; Write-Host '後端 HTTP: http://localhost:3001' -ForegroundColor Cyan; Write-Host '後端 HTTPS: https://localhost:3443' -ForegroundColor Cyan; Write-Host ''; Write-Host '容器狀態:' -ForegroundColor Yellow; docker-compose -p infosec ps; Write-Host ''; Write-Host '=======================================' -ForegroundColor Cyan; Write-Host '測試說明:' -ForegroundColor White; Write-Host '1. 開啟瀏覽器訪問 http://localhost:3000' -ForegroundColor White; Write-Host '2. 測試用戶註冊和登入功能 (注意: 前端使用 HTTPS API)' -ForegroundColor White; Write-Host '3. 測試 2FA 功能' -ForegroundColor White; Write-Host '4. 測試受保護資源存取' -ForegroundColor White; Write-Host '5. 測試 HTTPS 強制 (瀏覽器會顯示證書警告，請點擊繼續)' -ForegroundColor White; Write-Host '=======================================' -ForegroundColor Cyan; Write-Host ''; Write-Host '測試完成後，運行以下命令清理:' -ForegroundColor Yellow; Write-Host 'test-docker.bat -Clean' -ForegroundColor Cyan; Write-Host ''; Read-Host '按 Enter 鍵繼續 (容器會在背景運行)' } else { Write-Host '建置失敗！' -ForegroundColor Red; Write-Host '請檢查 Docker 配置和網路連接' -ForegroundColor Red; Read-Host '按 Enter 鍵退出'; exit 1 } }"